<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#be3455">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pereste Parse">
    <title>Pereste Parse</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #FFF5F5;
            --bg-card: #FFFFFF;
            --bg-input: #CFCCB6;
            --border: #D0B5A0;
            --text-primary: #000000;
            --text-secondary: #4a4a4a;
            --accent: #be3455;
            --accent-hover: #d14363;
            --success: #4ade80;
            --error: #be3455;
            --warning: #fbbf24;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            line-height: 1.6;
        }

        code,
        pre,
        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .health-status {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .health-status.ok {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.3);
            color: var(--success);
        }

        .health-status.error {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
            color: var(--error);
        }

        .health-status.loading {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: var(--warning);
        }

        .session-bar {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-group label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .input-group input {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: 'Outfit', sans-serif;
            transition: border-color 0.2s;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .input-zone {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .input-zone label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .input-zone textarea {
            width: 100%;
            min-height: 120px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: 'Outfit', sans-serif;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .input-zone textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Force black text in all inputs and textareas */
        input,
        textarea,
        select {
            color: #000000 !important;
        }

        input::placeholder,
        textarea::placeholder {
            color: #4a4a4a !important;
            opacity: 0.7;
        }

        .input-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .shortcut-hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Outfit', sans-serif;
        }

        button:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        button.secondary:hover {
            background: var(--border);
        }

        button.danger {
            background: var(--error);
        }

        button.danger:hover {
            background: #dc2626;
        }

        .stats-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-card.correct .stat-value {
            color: var(--success);
        }

        .stat-card.incorrect .stat-value {
            color: var(--error);
        }

        .table-wrapper {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }

        thead {
            background: var(--bg-input);
            border-bottom: 1px solid var(--border);
        }

        th {
            text-align: left;
            padding: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
            user-select: text;
            -webkit-user-select: text;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: var(--bg-input);
        }

        tbody tr.new-entry {
            animation: highlight 1s ease-out;
        }

        @keyframes highlight {
            0% {
                background: rgba(190, 52, 85, 0.3);
            }

            100% {
                background: transparent;
            }
        }

        .result-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .result-badge:hover {
            transform: scale(1.05);
            border-color: var(--text-primary);
        }

        .result-badge.correct {
            background: rgba(74, 222, 128, 0.2);
            color: var(--success);
        }

        .result-badge.correct:hover {
            background: rgba(74, 222, 128, 0.3);
        }

        .result-badge.incorrect {
            background: rgba(248, 113, 113, 0.2);
            color: var(--error);
        }

        .result-badge.incorrect:hover {
            background: rgba(248, 113, 113, 0.3);
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag {
            background: var(--bg-input);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
        }

        .cell-content {
            max-width: 100%;
            overflow: hidden;
            user-select: text;
            -webkit-user-select: text;
        }

        .cell-content.expandable {
            cursor: pointer;
            max-height: 3em;
            line-height: 1.5em;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cell-content.expandable ul,
        .cell-content.expandable p {
            margin: 0;
            padding: 0;
            display: inline;
        }

        .cell-content.expandable ul {
            list-style: none;
        }

        .cell-content.expandable li {
            display: inline;
        }

        .cell-content.expandable li:before {
            content: "• ";
        }

        .cell-content.expanded {
            max-height: none;
            display: block;
            -webkit-line-clamp: unset;
            -webkit-box-orient: unset;
        }

        .cell-content.expanded ul {
            display: block;
            list-style: disc;
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .cell-content.expanded p {
            display: block;
            margin: 0.25rem 0;
        }

        .cell-content.expanded li {
            display: list-item;
        }

        .cell-content.expanded li:before {
            content: none;
        }

        .delete-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            background: transparent;
            color: var(--error);
            border: 1px solid var(--border);
        }

        .delete-btn:hover {
            background: var(--error);
            color: white;
            border-color: var(--error);
        }

        .export-popup {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            z-index: 100;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            min-width: 260px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .export-popup-sections {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 0.75rem;
        }

        .export-popup-section-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0;
            font-size: 0.9rem;
            color: var(--text-primary);
            cursor: pointer;
        }

        .export-popup-section-item:hover {
            color: var(--accent);
        }

        .export-popup-section-item input[type="checkbox"] {
            accent-color: var(--accent);
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .export-popup-toggle {
            font-size: 0.8rem;
            color: var(--accent);
            cursor: pointer;
            margin-bottom: 0.5rem;
            padding: 0;
            background: none;
            border: none;
            font-family: 'Outfit', sans-serif;
        }

        .export-popup-toggle:hover {
            color: var(--accent-hover);
            background: none;
            transform: none;
        }

        .export-popup-divider {
            border: none;
            border-top: 1px solid var(--border);
            margin: 0.75rem 0;
        }

        .export-popup-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .export-popup-actions button {
            width: 100%;
            padding: 0.6rem;
            font-size: 0.9rem;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .empty-state-text {
            font-size: 0.95rem;
        }

        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse-record {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(248, 113, 113, 0.6);
            }

            50% {
                box-shadow: 0 0 0 12px rgba(248, 113, 113, 0);
            }
        }

        .record-btn:hover {
            transform: scale(1.1);
        }

        .error-message {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
            color: var(--error);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex: 1;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .filter-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .section-accordion {
            margin-bottom: 1rem;
        }

        .section-header {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
        }

        .section-header:hover {
            background: var(--bg-input);
        }

        .section-header.collapsed {
            margin-bottom: 0;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .section-stats {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            font-size: 0.9rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .section-stat {
            color: var(--text-secondary);
        }

        .section-stat.correct {
            color: var(--success);
        }

        .section-stat.incorrect {
            color: var(--error);
        }

        .chevron {
            color: var(--text-secondary);
            transition: transform 0.2s;
            font-size: 1.2rem;
        }

        .chevron.expanded {
            transform: rotate(90deg);
        }

        .section-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--text-primary);
            background: transparent;
            transform: none;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .anki-card {
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            min-height: 200px;
            margin-bottom: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .anki-card:hover {
            border-color: var(--accent);
        }

        .anki-card-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        .anki-card-content {
            font-size: 1rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .formatted-content {
            line-height: 1.8;
        }

        .formatted-content ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .formatted-content li {
            margin: 0.25rem 0;
        }

        .formatted-content p {
            margin: 0.5rem 0;
        }

        .formatted-content strong {
            color: var(--accent);
            font-weight: 600;
        }

        .anki-card-hint {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .edit-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: 'Outfit', sans-serif;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .result-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .result-toggle button {
            flex: 1;
            padding: 0.75rem;
        }

        .result-toggle button.active {
            background: var(--accent);
            color: white;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .edit-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            background: var(--accent);
            color: white;
            border: none;
        }

        .edit-btn:hover {
            background: var(--accent-hover);
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            height: 48px;
            width: auto;
        }

        .header-text h1 {
            margin-bottom: 0.25rem;
        }

        .settings-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .settings-btn:hover {
            background: var(--bg-input);
            color: var(--text-primary);
            transform: none;
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .settings-form .form-group select {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: 'Outfit', sans-serif;
        }

        .settings-form .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .model-cards {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .model-card {
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
        }

        .model-card:hover {
            border-color: var(--text-secondary);
        }

        .model-card.selected {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.08);
        }

        .model-card-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .model-card-desc {
            font-size: 0.78rem;
            color: var(--text-secondary);
            margin-top: 0.15rem;
        }

        .backend-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .backend-toggle button {
            flex: 1;
            padding: 0.75rem;
        }

        .backend-toggle button.active {
            background: var(--accent);
            color: white;
        }

        .test-result {
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .test-result.success {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.3);
            color: var(--success);
        }

        .test-result.failure {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
            color: var(--error);
        }

        .health-status.cloud {
            background: rgba(190, 52, 85, 0.1);
            border: 1px solid rgba(190, 52, 85, 0.3);
            color: var(--accent);
        }

        .health-status.downloading {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: var(--warning);
        }

        .setup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 2rem;
        }

        .setup-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-width: 540px;
            width: 100%;
            padding: 2.5rem;
        }

        .setup-title {
            font-size: 1.6rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .setup-subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .setup-option {
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .setup-option:hover {
            border-color: var(--accent);
        }

        .setup-option.selected {
            border-color: var(--accent);
            background: rgba(190, 52, 85, 0.08);
        }

        .setup-option-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .setup-option-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .setup-actions {
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
        }

        .download-progress {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .download-progress .download-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .download-progress .progress-bar-track {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .download-progress .progress-bar-fill {
            height: 100%;
            border-radius: 3px;
            background: linear-gradient(90deg, var(--accent), #818cf8);
            animation: progress-indeterminate 1.8s ease-in-out infinite;
            width: 40%;
        }

        @keyframes progress-indeterminate {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(350%);
            }
        }

        .download-progress.complete {
            border-color: rgba(74, 222, 128, 0.3);
            color: var(--success);
            flex-direction: row;
            align-items: center;
        }

        .download-progress.error {
            border-color: rgba(248, 113, 113, 0.3);
            color: var(--error);
            flex-direction: row;
            align-items: center;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 3000;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .kbd {
            display: inline-block;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.15rem 0.4rem;
            font-size: 0.78rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .shortcuts-table {
            width: 100%;
            border-collapse: collapse;
        }

        .shortcuts-table td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .shortcuts-table tr:last-child td {
            border-bottom: none;
        }

        .shortcuts-table td:first-child {
            white-space: nowrap;
            text-align: right;
            width: 40%;
        }

        .getting-started-steps {
            text-align: left;
            display: inline-block;
            margin: 1.5rem 0;
        }

        .getting-started-steps li {
            margin-bottom: 0.75rem;
            font-size: 1rem;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .getting-started-steps li span.step-num {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.6rem;
            height: 1.6rem;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 0.75rem;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const SHORTCUTS = [
            { keys: '\u2318\u21E7R', desc: 'Record / stop (or Next in flow mode)' },
            { keys: '\u2318\u21A9', desc: 'Parse transcription' },
            { keys: '\u2318\u232B', desc: 'Clear transcription' },
            { keys: '\u2318,', desc: 'Open / close Settings' },
            { keys: '\u2318F', desc: 'Focus search' },
            { keys: 'Esc', desc: 'Close topmost modal' },
            { keys: '\u23181 / \u23182 / \u23183', desc: 'Filter: All / Correct / Incorrect' },
            { keys: '\u2318\u21E7E', desc: 'Toggle export menu' },
            { keys: '\u2318J', desc: 'Scroll to latest entry' },
            { keys: '\u2318Z', desc: 'Undo last parse' },
            { keys: '\u2318\u21E7F', desc: 'Start / stop flow mode' },
            { keys: '? or \u2318/', desc: 'Show keyboard shortcuts' },
        ];

        const MODEL_PRESETS = [
            {
                id: 'qwen2.5-1.5b',
                name: 'Qwen 2.5 1.5B (Fastest)',
                repo_id: 'Qwen/Qwen2.5-1.5B-Instruct-GGUF',
                filename: 'qwen2.5-1.5b-instruct-q4_k_m.gguf',
                context_size: 8192,
                size: '~1.0 GB',
                description: 'Smallest model. Fast, low RAM usage. May hallucinate more.',
                recommended: false
            },
            {
                id: 'llama3.2-3b',
                name: 'Llama 3.2 3B (Balanced)',
                repo_id: 'bartowski/Llama-3.2-3B-Instruct-GGUF',
                filename: 'Llama-3.2-3B-Instruct-Q4_K_M.gguf',
                context_size: 8192,
                size: '~2.0 GB',
                description: 'Good balance of speed and quality. Works on most machines.',
                recommended: true
            },
            {
                id: 'qwen3-4b',
                name: 'Qwen 3 4B (Default)',
                repo_id: 'Qwen/Qwen3-4B-GGUF',
                filename: 'Qwen3-4B-Q4_K_M.gguf',
                context_size: 8192,
                size: '~2.5 GB',
                description: 'Current default. Good quality, reasonable speed.',
                recommended: false
            },
            {
                id: 'llama3.1-8b',
                name: 'Llama 3.1 8B (Best Quality)',
                repo_id: 'bartowski/Meta-Llama-3.1-8B-Instruct-GGUF',
                filename: 'Meta-Llama-3.1-8B-Instruct-Q4_K_M.gguf',
                context_size: 8192,
                size: '~4.9 GB',
                description: 'Largest model. Best quality, less hallucination. Needs 8GB+ RAM.',
                recommended: false
            }
        ];

        function App() {
            const [health, setHealth] = useState({ status: 'loading' });
            const [section, setSection] = useState(() => localStorage.getItem('section') || '');
            const [startNumber, setStartNumber] = useState(() => localStorage.getItem('startNumber') || '');
            const [transcription, setTranscription] = useState('');
            const [entries, setEntries] = useState([]);
            const [parsing, setParsing] = useState(false);
            const [parseQueue, setParseQueue] = useState([]);
            const [error, setError] = useState(null);
            const [debugLog, setDebugLog] = useState([]);
            const [showDebug, setShowDebug] = useState(false);
            const [expandedCells, setExpandedCells] = useState(new Set());
            const [filter, setFilter] = useState('all'); // 'all', 'correct', 'incorrect'
            const [collapsedSections, setCollapsedSections] = useState(() => {
                try {
                    const saved = localStorage.getItem('collapsedSections');
                    return saved ? new Set(JSON.parse(saved)) : new Set();
                } catch { return new Set(); }
            });
            const [editingEntry, setEditingEntry] = useState(null);
            const [showingFront, setShowingFront] = useState(true);
            const [recording, setRecording] = useState(false); // idle, recording
            const [transcribing, setTranscribing] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [settings, setSettings] = useState(null);
            const [settingsForm, setSettingsForm] = useState(null);
            const [testingConnection, setTestingConnection] = useState(false);
            const [testResult, setTestResult] = useState(null);
            const [showAdvanced, setShowAdvanced] = useState(false);
            const [showSetup, setShowSetup] = useState(false);
            const [setupStep, setSetupStep] = useState('choose');
            const [setupBackend, setSetupBackend] = useState('cloud');
            const [setupApiKey, setSetupApiKey] = useState('');
            const [setupModel, setSetupModel] = useState('claude-sonnet-4-5-20250929');
            const [setupSelectedModel, setSetupSelectedModel] = useState(MODEL_PRESETS.find(p => p.recommended) || MODEL_PRESETS[1]);
            const [setupTestResult, setSetupTestResult] = useState(null);
            const [setupTesting, setSetupTesting] = useState(false);
            const [downloadStatus, setDownloadStatus] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [toast, setToast] = useState(null);
            const [showCustomModel, setShowCustomModel] = useState(false);
            const [modelStatuses, setModelStatuses] = useState({});
            const [downloadingModelId, setDownloadingModelId] = useState(null);
            const [lastParse, setLastParse] = useState(null);
            const [showShortcuts, setShowShortcuts] = useState(false);
            const [showExportMenu, setShowExportMenu] = useState(false);
            const [flowMode, setFlowMode] = useState(() => localStorage.getItem('flowMode') === 'true');
            const [exportSections, setExportSections] = useState(new Set());
            const textareaRef = useRef(null);
            const tableEndRef = useRef(null);
            const searchRef = useRef(null);
            const exportMenuRef = useRef(null);
            const isInitialMount = useRef(true);
            const toastTimeoutRef = useRef(null);
            const flowPendingAction = useRef(null); // 'next' | 'redo' | null
            const handleParseRef = useRef(null);

            // Refs for keyboard handler to avoid stale closures
            const filterRef = useRef(filter);
            const lastParseRef = useRef(lastParse);
            const editingEntryRef = useRef(editingEntry);
            const showSettingsRef = useRef(showSettings);
            const showShortcutsRef = useRef(showShortcuts);
            const showSetupRef = useRef(showSetup);
            const showExportMenuRef = useRef(showExportMenu);
            useEffect(() => {
                filterRef.current = filter;
                lastParseRef.current = lastParse;
                editingEntryRef.current = editingEntry;
                showSettingsRef.current = showSettings;
                showShortcutsRef.current = showShortcuts;
                showSetupRef.current = showSetup;
                showExportMenuRef.current = showExportMenu;
            }, [filter, lastParse, editingEntry, showSettings, showShortcuts, showSetup, showExportMenu]);

            function showToast(message) {
                if (toastTimeoutRef.current) clearTimeout(toastTimeoutRef.current);
                setToast(message);
                toastTimeoutRef.current = setTimeout(() => setToast(null), 2000);
            }

            async function checkModelStatuses() {
                try {
                    const res = await fetch('/api/models/check-all', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ models: MODEL_PRESETS })
                    });
                    const data = await res.json();
                    setModelStatuses(data);
                } catch (err) {
                    console.error('Failed to check model statuses:', err);
                }
            }

            async function downloadModel(preset) {
                if (downloadingModelId) {
                    showToast('A model is already downloading');
                    return;
                }

                setDownloadingModelId(preset.id);
                try {
                    // Save the model config
                    await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            llm_repo_id: preset.repo_id,
                            llm_filename: preset.filename,
                            llm_context_size: preset.context_size
                        })
                    });

                    // Trigger download
                    await fetch('/api/models/download', { method: 'POST' });

                    // Poll for completion
                    const pollInterval = setInterval(async () => {
                        try {
                            const res = await fetch('/api/models/status');
                            const data = await res.json();
                            checkModelStatuses();

                            if (data.llm === 'ready') {
                                clearInterval(pollInterval);
                                setDownloadingModelId(null);
                                showToast('Model downloaded successfully!');
                                checkHealth();
                            } else if (data.llm === 'error') {
                                clearInterval(pollInterval);
                                setDownloadingModelId(null);
                                showToast('Download failed');
                            }
                        } catch (err) {
                            // ignore polling errors
                        }
                    }, 3000);
                } catch (err) {
                    setDownloadingModelId(null);
                    showToast('Failed to start download');
                }
            }

            async function deleteModel(preset) {
                if (!confirm(`Delete ${preset.name}? You can re-download it later.`)) {
                    return;
                }

                try {
                    const res = await fetch('/api/models/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: preset.filename })
                    });

                    const data = await res.json();
                    if (res.ok && data.status === 'deleted') {
                        showToast('Model deleted');
                        checkModelStatuses();
                        checkHealth();
                    } else {
                        showToast('Failed to delete model');
                    }
                } catch (err) {
                    showToast('Error deleting model');
                }
            }

            function renderLocalModelFields() {
                // Detect which preset is currently selected
                const currentPreset = MODEL_PRESETS.find(p =>
                    p.repo_id === settingsForm.llm_repo_id &&
                    p.filename === settingsForm.llm_filename
                );

                return (
                    <>
                        <div className="form-group">
                            <label>Language Model</label>
                            <div className="model-cards">
                                {MODEL_PRESETS.map(preset => {
                                    const status = modelStatuses[preset.id];
                                    const isDownloading = downloadingModelId === preset.id;
                                    const isDownloaded = status?.downloaded;
                                    const isSelected = currentPreset?.id === preset.id;

                                    return (
                                        <div
                                            key={preset.id}
                                            className={`model-card ${isSelected ? 'selected' : ''}`}
                                            style={{ cursor: 'default', position: 'relative' }}
                                        >
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '0.25rem' }}>
                                                <div className="model-card-name">
                                                    {preset.name} {preset.recommended && '⭐'}
                                                </div>
                                                {isDownloading && (
                                                    <span className="loading" style={{ width: '14px', height: '14px', borderWidth: '2px' }}></span>
                                                )}
                                                {!isDownloading && isDownloaded && (
                                                    <span style={{ fontSize: '0.85rem', color: 'var(--success)', fontWeight: 600 }}>✓ Downloaded</span>
                                                )}
                                            </div>
                                            <div className="model-card-desc" style={{ marginBottom: isDownloaded ? '0' : '0.5rem' }}>
                                                {preset.description}
                                            </div>
                                            {!isDownloading && !isDownloaded && (
                                                <button
                                                    className="secondary"
                                                    style={{ fontSize: '0.8rem', padding: '0.35rem 0.75rem', width: '100%', marginTop: '0.5rem' }}
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        downloadModel(preset);
                                                    }}
                                                >
                                                    Download {preset.size}
                                                </button>
                                            )}
                                            {!isDownloading && isDownloaded && !isSelected && (
                                                <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.5rem' }}>
                                                    <button
                                                        className="secondary"
                                                        style={{ fontSize: '0.8rem', padding: '0.35rem 0.75rem', flex: 1 }}
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            setSettingsForm(prev => ({
                                                                ...prev,
                                                                llm_repo_id: preset.repo_id,
                                                                llm_filename: preset.filename,
                                                                llm_context_size: preset.context_size
                                                            }));
                                                            setShowCustomModel(false);
                                                            showToast('Model selected');
                                                        }}
                                                    >
                                                        Use This Model
                                                    </button>
                                                    <button
                                                        className="secondary"
                                                        style={{ fontSize: '0.8rem', padding: '0.35rem 0.75rem', color: 'var(--error)' }}
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            deleteModel(preset);
                                                        }}
                                                    >
                                                        Delete
                                                    </button>
                                                </div>
                                            )}
                                            {isSelected && isDownloaded && (
                                                <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.5rem', alignItems: 'center' }}>
                                                    <div style={{ fontSize: '0.75rem', color: 'var(--accent)', fontWeight: 600, flex: 1, textAlign: 'center' }}>
                                                        Currently Active
                                                    </div>
                                                    <button
                                                        className="secondary"
                                                        style={{ fontSize: '0.75rem', padding: '0.3rem 0.6rem', color: 'var(--error)' }}
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            deleteModel(preset);
                                                        }}
                                                        disabled
                                                        title="Cannot delete active model"
                                                    >
                                                        Delete
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        <div style={{ fontSize: '0.85rem', marginTop: '0.5rem' }}>
                            <a
                                href="#"
                                onClick={(e) => { e.preventDefault(); setShowCustomModel(!showCustomModel); }}
                                style={{ color: 'var(--accent)', textDecoration: 'none' }}
                            >
                                {showCustomModel ? '← Use preset models' : 'Use custom model →'}
                            </a>
                        </div>

                        {showCustomModel && (
                            <>
                                <div className="form-group">
                                    <label>LLM Repo ID</label>
                                    <input type="text" value={settingsForm.llm_repo_id || ''} onChange={e => setSettingsForm(prev => ({ ...prev, llm_repo_id: e.target.value }))} />
                                </div>
                                <div className="form-group">
                                    <label>LLM Filename</label>
                                    <input type="text" value={settingsForm.llm_filename || ''} onChange={e => setSettingsForm(prev => ({ ...prev, llm_filename: e.target.value }))} />
                                </div>
                                <div className="form-group">
                                    <label>Context Size</label>
                                    <input type="number" value={settingsForm.llm_context_size || ''} onChange={e => setSettingsForm(prev => ({ ...prev, llm_context_size: parseInt(e.target.value) || '' }))} />
                                </div>
                            </>
                        )}

                        <div className="form-group">
                            <label>STT Model</label>
                            <input type="text" value={settingsForm.stt_model_id || ''} onChange={e => setSettingsForm(prev => ({ ...prev, stt_model_id: e.target.value }))} />
                        </div>
                    </>
                );
            }

            // Convert bullet points and formatting to HTML
            function formatContent(text) {
                if (!text) return '';

                try {
                    // Helper to apply inline formatting
                    function applyInlineFormatting(content) {
                        return content
                            // Escape HTML first
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            // Bold: **text** or __text__
                            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                            .replace(/__(.+?)__/g, '<strong>$1</strong>')
                            // Italic: *text* or _text_ (but not **, __)
                            .replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>')
                            .replace(/(?<!_)_(?!_)(.+?)(?<!_)_(?!_)/g, '<em>$1</em>')
                            // Inline code: `code`
                            .replace(/`(.+?)`/g, '<code style="background: var(--bg-input); padding: 0.15rem 0.35rem; border-radius: 3px; font-family: \'JetBrains Mono\', monospace; font-size: 0.9em;">$1</code>');
                    }

                    // Split into lines
                    let lines = text.split('\n');
                    let html = '';
                    let inBulletList = false;
                    let inNumberedList = false;

                    lines.forEach((line, index) => {
                        line = line.trim();

                        // Check if line is a bullet point (•, -, * at start)
                        const bulletMatch = line.match(/^[•\-\*]\s+(.+)$/);
                        // Check if line is a numbered list (1., 2., etc.)
                        const numberedMatch = line.match(/^\d+\.\s+(.+)$/);

                        if (bulletMatch) {
                            if (inNumberedList) {
                                html += '</ol>';
                                inNumberedList = false;
                            }
                            if (!inBulletList) {
                                html += '<ul>';
                                inBulletList = true;
                            }
                            const content = applyInlineFormatting(bulletMatch[1]);
                            html += `<li>${content}</li>`;
                        } else if (numberedMatch) {
                            if (inBulletList) {
                                html += '</ul>';
                                inBulletList = false;
                            }
                            if (!inNumberedList) {
                                html += '<ol>';
                                inNumberedList = true;
                            }
                            const content = applyInlineFormatting(numberedMatch[1]);
                            html += `<li>${content}</li>`;
                        } else {
                            if (inBulletList) {
                                html += '</ul>';
                                inBulletList = false;
                            }
                            if (inNumberedList) {
                                html += '</ol>';
                                inNumberedList = false;
                            }
                            if (line) {
                                const formatted = applyInlineFormatting(line);
                                html += `<p>${formatted}</p>`;
                            }
                        }
                    });

                    // Close any open lists
                    if (inBulletList) html += '</ul>';
                    if (inNumberedList) html += '</ol>';

                    return html || text; // Fallback to original text if empty
                } catch (e) {
                    console.error('Error formatting content:', e);
                    // Fallback to plain text
                    return text.replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/\n/g, '<br>');
                }
            }

            useEffect(() => {
                async function init() {
                    const healthData = await checkHealth();
                    loadEntries();
                    checkModelStatuses();
                    try {
                        const res = await fetch('/api/config');
                        const config = await res.json();
                        if (!config.setup_complete) {
                            if (healthData && healthData.status === 'ok') {
                                // Existing user upgrading — silently mark complete
                                await fetch('/api/config', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ setup_complete: true })
                                });
                            } else {
                                setShowSetup(true);
                            }
                        }
                    } catch (err) {
                        console.error('Failed to check setup status:', err);
                    }
                }
                init();
            }, []);

            // Auto-focus textarea on mount
            useEffect(() => {
                textareaRef.current?.focus();
            }, []);

            // Health polling: poll every 3s while setup is open or health is downloading
            useEffect(() => {
                if (!showSetup && health.status !== 'downloading') return;
                const interval = setInterval(() => {
                    checkHealth();
                }, 3000);
                return () => clearInterval(interval);
            }, [showSetup, health.status]);

            // Close export menu on click outside
            useEffect(() => {
                if (!showExportMenu) return;
                function handleClickOutside(e) {
                    if (exportMenuRef.current && !exportMenuRef.current.contains(e.target)) {
                        setShowExportMenu(false);
                    }
                }
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [showExportMenu]);

            // Initialize exportSections when entries change
            useEffect(() => {
                const allSections = new Set(entries.map(e => e.section || 'Uncategorized'));
                setExportSections(allSections);
            }, [entries.length]);

            useEffect(() => {
                localStorage.setItem('section', section);
            }, [section]);

            useEffect(() => {
                localStorage.setItem('startNumber', startNumber);
            }, [startNumber]);

            useEffect(() => {
                // Skip saving on initial mount to avoid race condition
                if (isInitialMount.current) {
                    isInitialMount.current = false;
                    return;
                }

                // Save to both localStorage and backend
                localStorage.setItem('entries', JSON.stringify(entries));
                saveEntries(entries);
            }, [entries]);

            useEffect(() => {
                localStorage.setItem('collapsedSections', JSON.stringify([...collapsedSections]));
            }, [collapsedSections]);

            useEffect(() => {
                localStorage.setItem('flowMode', flowMode);
            }, [flowMode]);

            // Chain flow actions after transcription finishes
            useEffect(() => {
                if (!transcribing && flowPendingAction.current) {
                    const action = flowPendingAction.current;
                    flowPendingAction.current = null;

                    if (action === 'next') {
                        handleParseRef.current();
                    } else if (action === 'redo') {
                        setTranscription('');
                        startRecording();
                    }
                }
            }, [transcribing]);

            async function checkHealth() {
                try {
                    const res = await fetch('/api/health');
                    const data = await res.json();
                    setHealth(data);
                    return data;
                } catch (err) {
                    const errData = { status: 'error', message: 'Could not connect to server' };
                    setHealth(errData);
                    return errData;
                }
            }

            async function loadEntries() {
                try {
                    const res = await fetch('/api/load');
                    const data = await res.json();
                    if (data.entries) {
                        setEntries(data.entries);
                    }
                } catch (err) {
                    console.error('Failed to load entries:', err);
                    // Fallback to localStorage
                    const saved = localStorage.getItem('entries');
                    if (saved) {
                        setEntries(JSON.parse(saved));
                    }
                }
            }

            async function saveEntries(entries) {
                try {
                    await fetch('/api/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ entries })
                    });
                } catch (err) {
                    console.error('Failed to save entries:', err);
                }
            }

            // Add to parse queue
            function handleParse() {
                if (!transcription.trim()) return;

                const queueItem = {
                    id: Date.now(),
                    transcription: transcription.trim(),
                    section: section
                };

                setParseQueue(prev => [...prev, queueItem]);
                setTranscription('');
                textareaRef.current?.focus();
                showToast(`Added to queue (${parseQueue.length + 1} items)`);

                // Flow mode: auto-start recording for next entry
                if (flowMode && !recording) {
                    setTimeout(() => startRecording(), 100);
                }
            }

            // Keep handleParseRef in sync so flow useEffect can call latest version
            handleParseRef.current = handleParse;

            function handleFlowNext() {
                flowPendingAction.current = 'next';
                stopRecording();
            }

            function handleFlowRedo() {
                flowPendingAction.current = 'redo';
                stopRecording();
            }

            function handleFlowStop() {
                flowPendingAction.current = null;
                if (recording) stopRecording();
                setFlowMode(false);
            }

            // Process queue - runs when queue changes and not currently parsing
            useEffect(() => {
                if (parsing || parseQueue.length === 0) return;

                const processNext = async () => {
                    const item = parseQueue[0];
                    setParsing(true);
                    setError(null);

                    try {
                        const res = await fetch('/api/parse', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                transcription: item.transcription,
                                section: item.section
                            })
                        });

                        const data = await res.json();

                        if (!res.ok) {
                            const errorMsg = data.error || 'Failed to parse';
                            const fullError = {
                                message: errorMsg,
                                details: data.details,
                                raw_response: data.raw_response
                            };
                            console.error('Parse error:', fullError);
                            throw new Error(JSON.stringify(fullError));
                        }

                        // Capture debug info
                        if (data._debug) {
                            setDebugLog(prev => [...prev, { ...data._debug, timestamp: new Date().toLocaleTimeString() }]);
                            delete data._debug;
                        }

                        // Auto-increment question number
                        if (!data.number || data.number === null) {
                            setEntries(prevEntries => {
                                const lastEntry = prevEntries[prevEntries.length - 1];
                                const lastNumber = lastEntry?.number || 0;
                                data.number = lastNumber + 1;
                                return prevEntries;
                            });
                        }

                        // Get default result from settings
                        const defaultResult = settings?.default_result || 'incorrect';

                        // Add entry
                        const newEntry = {
                            ...data,
                            tags: (data.tags || []).map(t => t.trim().replace(/\s+/g, '_')).filter(Boolean),
                            result: defaultResult,
                            id: Date.now(),
                            timestamp: new Date().toISOString(),
                            isNew: true
                        };

                        setEntries(prev => [...prev, newEntry]);
                        setLastParse({ entry: newEntry, transcription: item.transcription });

                        // Remove highlight animation after 1s
                        setTimeout(() => {
                            setEntries(prev => prev.map(e =>
                                e.id === newEntry.id ? { ...e, isNew: false } : e
                            ));
                        }, 1000);

                        // Remove from queue and trigger next
                        setParseQueue(prev => prev.slice(1));
                        setParsing(false);

                    } catch (err) {
                        setError(err.message);
                        setParseQueue(prev => prev.slice(1));
                        setParsing(false);
                    }
                };

                processNext();
            }, [parseQueue, parsing]);

            function handleKeyDown(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleParse();
                }
            }

            // Global keyboard shortcuts
            useEffect(() => {
                function handleGlobalKeyDown(e) {
                    const tag = document.activeElement?.tagName;
                    const inInput = tag === 'INPUT' || tag === 'TEXTAREA';

                    // Cmd+Shift+R — toggle recording (or Next in flow mode)
                    if (e.metaKey && e.shiftKey && e.key === 'r') {
                        e.preventDefault();
                        if (flowMode) {
                            if (recording) {
                                handleFlowNext();
                            } else if (!transcribing) {
                                startRecording();
                            }
                        } else {
                            if (!parsing && !transcribing) {
                                // Toggle recording: if recording, stop; if not, check permissions/start
                                if (recording) stopRecording();
                                else startRecording();
                            }
                        }
                        return;
                    }

                    // Escape — cancel recording or exit flow mode
                    if (e.key === 'Escape') {
                        if (recording) {
                            console.log('Cancelling recording via Escape');
                            stopRecording();
                            setTranscription('');
                            showToast('Recording cancelled');
                            return;
                        }
                        if (flowMode) {
                            setFlowMode(false);
                            showToast('Exited Flow Mode');
                            return;
                        }
                    }
                    // Cmd+Shift+F — toggle flow mode (auto-start recording when enabling)
                    if (e.metaKey && e.shiftKey && (e.key === 'f' || e.key === 'F')) {
                        e.preventDefault();
                        setFlowMode(prev => {
                            const next = !prev;
                            if (next && !recording && !transcribing) {
                                setTimeout(() => startRecording(), 100);
                            }
                            return next;
                        });
                        return;
                    }
                    // Cmd+Shift+E — toggle export menu
                    if (e.metaKey && e.shiftKey && (e.key === 'e' || e.key === 'E')) {
                        e.preventDefault();
                        setShowExportMenu(prev => !prev);
                        return;
                    }
                    // Cmd+Enter — parse
                    if (e.metaKey && e.key === 'Enter') {
                        e.preventDefault();
                        handleParse();
                        return;
                    }
                    // Cmd+Backspace — clear textarea
                    if (e.metaKey && e.key === 'Backspace') {
                        e.preventDefault();
                        setTranscription('');
                        textareaRef.current?.focus();
                        return;
                    }
                    // Cmd+, — toggle settings
                    if (e.metaKey && e.key === ',') {
                        e.preventDefault();
                        if (showSettingsRef.current) {
                            setShowSettings(false);
                        } else {
                            openSettings();
                        }
                        return;
                    }
                    // Cmd+F — focus search
                    if (e.metaKey && !e.shiftKey && e.key === 'f') {
                        e.preventDefault();
                        searchRef.current?.focus();
                        return;
                    }
                    // Cmd+1/2/3 — switch filter
                    if (e.metaKey && !e.shiftKey && (e.key === '1' || e.key === '2' || e.key === '3')) {
                        e.preventDefault();
                        const filters = { '1': 'all', '2': 'correct', '3': 'incorrect' };
                        setFilter(filters[e.key]);
                        return;
                    }
                    // Cmd+J — scroll to latest entry
                    if (e.metaKey && !e.shiftKey && e.key === 'j') {
                        e.preventDefault();
                        tableEndRef.current?.scrollIntoView({ behavior: 'smooth' });
                        return;
                    }
                    // Cmd+Z — undo last parse (only when not in text input)
                    if (e.metaKey && !e.shiftKey && e.key === 'z' && !inInput) {
                        e.preventDefault();
                        undoLastParse();
                        return;
                    }
                    // Cmd+/ or ? — show shortcuts
                    if (e.metaKey && e.key === '/') {
                        e.preventDefault();
                        setShowShortcuts(prev => !prev);
                        return;
                    }
                    // ? key (when not in input) — show shortcuts
                    if (e.key === '?' && !inInput) {
                        e.preventDefault();
                        setShowShortcuts(prev => !prev);
                        return;
                    }
                    // Escape — close topmost modal
                    if (e.key === 'Escape') {
                        if (showExportMenuRef.current) { setShowExportMenu(false); return; }
                        if (editingEntryRef.current) { setEditingEntry(null); return; }
                        if (showSettingsRef.current) { setShowSettings(false); return; }
                        if (showShortcutsRef.current) { setShowShortcuts(false); return; }
                        if (showSetupRef.current) { /* don't close setup with Escape */ return; }
                    }
                }
                window.addEventListener('keydown', handleGlobalKeyDown);
                return () => window.removeEventListener('keydown', handleGlobalKeyDown);
            }, [transcription, parsing, recording, transcribing, flowMode]);

            async function startRecording() {
                setError(null);
                try {
                    const res = await fetch('/api/record/start', { method: 'POST' });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Start recording failed');
                    setRecording(true);
                } catch (err) {
                    setError(JSON.stringify({ message: 'Could not start recording', details: err.message }));
                }
            }

            async function stopRecording() {
                setRecording(false);
                setTranscribing(true);
                try {
                    const res = await fetch('/api/record/stop', { method: 'POST' });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Stop recording failed');
                    setTranscription(prev => prev ? prev + ' ' + data.text : data.text);
                } catch (err) {
                    setError(JSON.stringify({ message: 'Recording failed', details: err.message }));
                } finally {
                    setTranscribing(false);
                }
            }

            async function toggleRecording() {
                if (recording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            }

            async function openSettings() {
                try {
                    const res = await fetch('/api/config');
                    const data = await res.json();
                    setSettings(data);
                    setSettingsForm({ ...data, api_key: '' }); // Don't prefill masked key
                    setTestResult(null);
                    setShowSettings(true);
                } catch (err) {
                    console.error('Failed to load settings:', err);
                }
            }

            async function saveSettings() {
                try {
                    const payload = { ...settingsForm };
                    // Only send api_key if user typed a new one
                    if (!payload.api_key) {
                        delete payload.api_key;
                    }
                    const res = await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Failed to save');
                    setSettings(data);
                    setShowSettings(false);
                    checkHealth(); // Refresh health status
                } catch (err) {
                    console.error('Failed to save settings:', err);
                    setTestResult({ ok: false, message: 'Failed to save: ' + err.message });
                }
            }

            async function testConnection() {
                setTestingConnection(true);
                setTestResult(null);
                try {
                    // Save settings first (including API key)
                    const payload = { ...settingsForm };
                    if (!payload.api_key) {
                        delete payload.api_key;
                    }
                    await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    // Then test by parsing a simple transcription
                    const res = await fetch('/api/parse', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            transcription: 'Question 1 was correct. The answer is the femur because it is the longest bone in the body.',
                            section: 'Test'
                        })
                    });
                    const data = await res.json();
                    if (res.ok && data.front) {
                        setTestResult({ ok: true, message: 'Connection successful! Parsed test transcription.' });
                    } else {
                        setTestResult({ ok: false, message: data.error || 'Parse failed' });
                    }
                } catch (err) {
                    setTestResult({ ok: false, message: 'Connection failed: ' + err.message });
                } finally {
                    setTestingConnection(false);
                }
            }

            async function setupTestConnection() {
                setSetupTesting(true);
                setSetupTestResult(null);
                try {
                    // Save API key + cloud backend temporarily
                    const payload = { parsing_backend: 'cloud', cloud_model: setupModel };
                    if (setupApiKey) payload.api_key = setupApiKey;
                    await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    // Test by parsing a simple transcription
                    const res = await fetch('/api/parse', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            transcription: 'Question 1 was correct. The answer is the femur because it is the longest bone in the body.',
                            section: 'Test'
                        })
                    });
                    const data = await res.json();
                    if (res.ok && data.front) {
                        setSetupTestResult({ ok: true, message: 'Connection successful!' });
                    } else {
                        setSetupTestResult({ ok: false, message: data.error || 'Parse failed' });
                    }
                } catch (err) {
                    setSetupTestResult({ ok: false, message: 'Connection failed: ' + err.message });
                } finally {
                    setSetupTesting(false);
                }
            }

            async function setupStartDownload() {
                setDownloadStatus('downloading');
                setDownloadingModelId(setupSelectedModel.id);
                try {
                    // First, save the selected model configuration
                    await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            llm_repo_id: setupSelectedModel.repo_id,
                            llm_filename: setupSelectedModel.filename,
                            llm_context_size: setupSelectedModel.context_size
                        })
                    });

                    // Then trigger the download
                    await fetch('/api/models/download', { method: 'POST' });

                    // Poll model status
                    const pollModels = setInterval(async () => {
                        try {
                            const res = await fetch('/api/models/status');
                            const data = await res.json();
                            checkModelStatuses(); // Refresh statuses
                            if (data.llm === 'ready') {
                                setDownloadStatus('ready');
                                setDownloadingModelId(null);
                                clearInterval(pollModels);
                            } else if (data.llm === 'error') {
                                setDownloadStatus('error');
                                setDownloadingModelId(null);
                                clearInterval(pollModels);
                            }
                        } catch (e) {
                            // ignore polling errors
                        }
                    }, 3000);
                } catch (err) {
                    setDownloadStatus('error');
                    setDownloadingModelId(null);
                }
            }

            async function setupDeleteModel() {
                try {
                    await fetch('/api/models/delete', { method: 'POST' });
                    setDownloadStatus(null);
                    checkHealth();
                } catch (err) {
                    console.error('Failed to delete model:', err);
                }
            }

            async function completeSetup() {
                try {
                    const payload = {
                        setup_complete: true,
                        parsing_backend: setupBackend,
                    };
                    if (setupBackend === 'cloud') {
                        if (setupApiKey) payload.api_key = setupApiKey;
                        payload.cloud_model = setupModel;
                    }
                    await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    await checkHealth();
                    setShowSetup(false);
                    // Reset setup state
                    setSetupStep('choose');
                    setSetupApiKey('');
                    setSetupTestResult(null);
                    setDownloadStatus(null);
                } catch (err) {
                    console.error('Failed to complete setup:', err);
                }
            }

            function deleteEntry(id) {
                if (confirm('Delete this entry?')) {
                    setEntries(prev => prev.filter(e => e.id !== id));
                    if (lastParse && lastParse.entry.id === id) setLastParse(null);
                }
            }

            function editEntry(entry) {
                setEditingEntry({ ...entry });
                setShowingFront(true);
            }

            function saveEdit() {
                if (!editingEntry) return;

                const updatedEntry = { ...editingEntry };
                const newNumber = updatedEntry.number;
                const newSection = updatedEntry.section || 'Uncategorized';

                let entriesToUpdate = [...entries];

                // Check for number conflict in the same section
                if (typeof newNumber === 'number') {
                    const conflict = entries.find(e =>
                        e.id !== updatedEntry.id &&
                        (e.section || 'Uncategorized') === newSection &&
                        e.number === newNumber
                    );

                    if (conflict) {
                        if (confirm(`Question #${newNumber} already exists in "${newSection}".\n\nShift existing #${newNumber} and subsequent questions down?`)) {
                            // Increment numbers of all entries in this section >= newNumber
                            entriesToUpdate = entriesToUpdate.map(e => {
                                if (e.id === updatedEntry.id) return e; // Skip self
                                const eSection = e.section || 'Uncategorized';
                                if (eSection === newSection && typeof e.number === 'number' && e.number >= newNumber) {
                                    return { ...e, number: e.number + 1 };
                                }
                                return e;
                            });
                            showToast(`Shifted subsequent questions in "${newSection}"`);
                        }
                    }
                }

                // Update section tag when section changes
                if (updatedEntry.section) {
                    const sectionTag = updatedEntry.section.toLowerCase().replace(/\s+/g, '_');

                    // Remove old section tags
                    const existingSections = entriesToUpdate.map(e => e.section?.toLowerCase().replace(/\s+/g, '_'));
                    updatedEntry.tags = (updatedEntry.tags || []).filter(tag =>
                        !existingSections.includes(tag)
                    );

                    // Add new section tag at the beginning
                    if (!updatedEntry.tags.includes(sectionTag)) {
                        updatedEntry.tags = [sectionTag, ...updatedEntry.tags];
                    }
                }

                setEntries(entriesToUpdate.map(e =>
                    e.id === updatedEntry.id ? updatedEntry : e
                ));
                setEditingEntry(null);
            }

            function updateEditingEntry(field, value) {
                setEditingEntry(prev => ({ ...prev, [field]: value }));
            }

            function flipCard() {
                setShowingFront(prev => !prev);
            }

            function toggleResult(id) {
                setEntries(prev => prev.map(e =>
                    e.id === id
                        ? { ...e, result: e.result === 'correct' ? 'incorrect' : 'correct' }
                        : e
                ));
            }

            function toggleCellExpand(id, field, event) {
                // Don't toggle if user is selecting text
                const selection = window.getSelection();
                if (selection && selection.toString().length > 0) {
                    return;
                }

                const key = `${id}-${field}`;
                setExpandedCells(prev => {
                    const next = new Set(prev);
                    if (next.has(key)) {
                        next.delete(key);
                    } else {
                        next.add(key);
                    }
                    return next;
                });
            }

            async function exportAnki(entriesToExport) {
                if (!entriesToExport || entriesToExport.length === 0) {
                    showToast('No entries to export');
                    return;
                }

                try {
                    const response = await fetch('/api/export-apkg', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            entries: entriesToExport,
                            filter: 'all'
                        })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Export failed');
                    }

                    showToast(`Anki deck exported to ${result.filename}`);
                } catch (err) {
                    console.error('Export error:', err);
                    showToast('Failed to export Anki deck: ' + err.message);
                }
            }

            async function exportCSV(entriesToExport) {
                if (!entriesToExport || entriesToExport.length === 0) {
                    showToast('No entries to export');
                    return;
                }

                try {
                    const response = await fetch('/api/export-csv', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            entries: entriesToExport,
                            filter: 'all'
                        })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Export failed');
                    }

                    showToast(`CSV exported to ${result.filename}`);
                } catch (err) {
                    console.error('Export error:', err);
                    showToast('Failed to export CSV: ' + err.message);
                }
            }

            function clearAll() {
                if (confirm('Clear all entries? This cannot be undone.')) {
                    setEntries([]);
                    setLastParse(null);
                }
            }

            function undoLastParse() {
                const lp = lastParseRef.current;
                if (!lp) return;
                setEntries(prev => prev.filter(e => e.id !== lp.entry.id));
                setTranscription(lp.transcription);
                setLastParse(null);
                showToast('Undo: entry removed, transcription restored');
                textareaRef.current?.focus();
            }

            function toggleSection(sectionName) {
                setCollapsedSections(prev => {
                    const next = new Set(prev);
                    if (next.has(sectionName)) {
                        next.delete(sectionName);
                    } else {
                        next.add(sectionName);
                    }
                    return next;
                });
            }

            // Filter entries based on current filter and search query
            const filteredEntries = entries.filter(e => {
                if (filter !== 'all' && e.result !== filter) return false;
                if (searchQuery) {
                    const q = searchQuery.toLowerCase();
                    return (e.front || '').toLowerCase().includes(q)
                        || (e.back || '').toLowerCase().includes(q)
                        || (e.notes || '').toLowerCase().includes(q);
                }
                return true;
            });

            // Get unique sections for dropdown
            const uniqueSections = [...new Set(entries.map(e => e.section).filter(Boolean))].sort();

            // Group entries by section
            const groupedEntries = filteredEntries.reduce((acc, entry) => {
                const sec = entry.section || 'Uncategorized';
                if (!acc[sec]) acc[sec] = [];
                acc[sec].push(entry);
                return acc;
            }, {});

            const stats = entries.reduce((acc, e) => {
                acc.total++;
                if (e.result === 'correct') acc.correct++;
                if (e.result === 'incorrect') acc.incorrect++;
                return acc;
            }, { total: 0, correct: 0, incorrect: 0 });

            const score = stats.total > 0
                ? Math.round((stats.correct / stats.total) * 100)
                : 0;

            return (
                <div style={{ display: 'flex', height: '100vh', overflow: 'hidden' }}>
                    <div style={{ flex: 1, overflow: 'auto' }}>
                        <div className="container">
                            <div className="header-row">
                                <div className="header-content">
                                    <img src="/plogo-icon.png" alt="Pereste Parse" className="logo" />
                                    <div className="header-text">
                                        <h1>Pereste Parse</h1>
                                        <p className="subtitle">Voice to flashcards</p>
                                    </div>
                                </div>
                                <div style={{ display: 'flex', gap: '0.25rem' }}>
                                    {settings?.debug_mode && (
                                        <button className="settings-btn" onClick={() => setShowDebug(prev => !prev)} title="Debug Panel" style={{ opacity: showDebug ? 1 : 0.5, fontSize: '1.1rem' }}>
                                            &#9776;
                                        </button>
                                    )}
                                    <button className="settings-btn" onClick={() => setShowShortcuts(true)} title="Keyboard Shortcuts (?)">
                                        ?
                                    </button>
                                    <button className="settings-btn" onClick={openSettings} title="Settings (\u2318,)">
                                        ⚙
                                    </button>
                                </div>
                            </div>


                            <div className="session-bar">
                                <div className="input-group">
                                    <label>Section</label>
                                    <input
                                        type="text"
                                        list="sections-datalist"
                                        placeholder="e.g. Upper Limb, Thorax"
                                        value={section}
                                        onChange={e => setSection(e.target.value)}
                                    />
                                    <datalist id="sections-datalist">
                                        {uniqueSections.map(sec => (
                                            <option key={sec} value={sec} />
                                        ))}
                                    </datalist>
                                </div>
                                <div className="input-group" style={{ maxWidth: '200px' }}>
                                    <label>Start Question #</label>
                                    <input
                                        type="number"
                                        placeholder="1"
                                        value={startNumber}
                                        onChange={e => setStartNumber(e.target.value)}
                                    />
                                </div>
                            </div>

                            <div className="input-zone">
                                <label>Record or Paste Transcription</label>
                                <textarea
                                    ref={textareaRef}
                                    value={transcription}
                                    onChange={e => setTranscription(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                    placeholder={recording ? 'Recording... click mic to stop' : 'Paste your transcription here...'}
                                    disabled={recording || transcribing}
                                />
                                <div className="input-actions">
                                    {flowMode ? (
                                        <>
                                            <span className="shortcut-hint">
                                                {recording ? 'Flow: Recording... \u2318\u21E7R next' : transcribing ? 'Flow: Processing...' : 'Flow: Idle'}
                                            </span>
                                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                                {recording ? (
                                                    <>
                                                        <button
                                                            onClick={handleFlowNext}
                                                            style={{
                                                                display: 'inline-flex',
                                                                alignItems: 'center',
                                                                gap: '0.4rem',
                                                                animation: 'pulse-record 1.5s ease-in-out infinite',
                                                            }}
                                                        >
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" style={{ flexShrink: 0 }}><polyline points="13 17 18 12 13 7" /><polyline points="6 17 11 12 6 7" /></svg>
                                                            Next
                                                        </button>
                                                        <button
                                                            onClick={handleFlowRedo}
                                                            className="secondary"
                                                            style={{ display: 'inline-flex', alignItems: 'center', gap: '0.4rem' }}
                                                        >
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" style={{ flexShrink: 0 }}><polyline points="1 4 1 10 7 10" /><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" /></svg>
                                                            Redo
                                                        </button>
                                                    </>
                                                ) : transcribing ? (
                                                    <button disabled style={{ display: 'inline-flex', alignItems: 'center', gap: '0.4rem' }}>
                                                        <span className="loading"></span> Processing...
                                                    </button>
                                                ) : (
                                                    <button
                                                        onClick={startRecording}
                                                        style={{ display: 'inline-flex', alignItems: 'center', gap: '0.4rem' }}
                                                    >
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" style={{ flexShrink: 0 }}><polygon points="5 3 19 12 5 21 5 3" /></svg>
                                                        Resume
                                                    </button>
                                                )}
                                                <button
                                                    onClick={handleFlowStop}
                                                    className="secondary"
                                                    style={{ display: 'inline-flex', alignItems: 'center', gap: '0.4rem' }}
                                                >
                                                    Stop Flow
                                                </button>
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <span className="shortcut-hint">{recording ? 'Recording...' : '\u2318\u21E7R record \u00B7 \u2318\u21A9 parse \u00B7 \u2318\u232B clear'}</span>
                                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                                <button
                                                    onClick={toggleRecording}
                                                    disabled={transcribing}
                                                    className={recording ? '' : 'secondary'}
                                                    style={{
                                                        display: 'inline-flex',
                                                        alignItems: 'center',
                                                        gap: '0.4rem',
                                                        background: recording ? 'var(--error)' : undefined,
                                                        animation: recording ? 'pulse-record 1.5s ease-in-out infinite' : 'none',
                                                    }}
                                                >
                                                    {transcribing ? (
                                                        <><span className="loading"></span> Transcribing...</>
                                                    ) : recording ? (
                                                        <><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style={{ flexShrink: 0 }}><rect x="3" y="3" width="10" height="10" rx="2" /></svg> Stop</>
                                                    ) : (
                                                        <><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" style={{ flexShrink: 0 }}><rect x="9" y="1" width="6" height="12" rx="3" /><path d="M5 10a7 7 0 0 0 14 0" /><line x1="12" y1="17" x2="12" y2="21" /><line x1="8" y1="21" x2="16" y2="21" /></svg> Record</>
                                                    )}
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        setFlowMode(prev => {
                                                            const next = !prev;
                                                            if (next && !recording && !transcribing) {
                                                                setTimeout(() => startRecording(), 100);
                                                            }
                                                            return next;
                                                        });
                                                    }}
                                                    className="secondary"
                                                    title="Flow mode: single-button workflow (\u2318\u21E7F)"
                                                    style={{
                                                        display: 'inline-flex',
                                                        alignItems: 'center',
                                                        gap: '0.3rem',
                                                        fontSize: '0.8rem',
                                                        padding: '0.35rem 0.6rem',
                                                    }}
                                                >
                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" style={{ flexShrink: 0 }}><polyline points="13 17 18 12 13 7" /><polyline points="6 17 11 12 6 7" /></svg>
                                                    Flow
                                                </button>
                                                <button
                                                    onClick={handleParse}
                                                    disabled={!transcription.trim() || recording || transcribing}
                                                >
                                                    {parsing && parseQueue.length > 0 ? (
                                                        <><span className="loading"></span> Processing ({parseQueue.length} queued)</>
                                                    ) : parsing ? (
                                                        <><span className="loading"></span> Parsing...</>
                                                    ) : parseQueue.length > 0 ? (
                                                        `Parse Question (${parseQueue.length} in queue)`
                                                    ) : (
                                                        'Parse Question'
                                                    )}
                                                </button>
                                            </div>
                                        </>
                                    )}
                                </div>
                                {error && (
                                    <div className="error-message">
                                        <strong>Error:</strong> {(() => {
                                            try {
                                                const errorObj = JSON.parse(error);
                                                return (
                                                    <div>
                                                        <div>{errorObj.message}</div>
                                                        {errorObj.details && <div style={{ marginTop: '0.5rem', fontSize: '0.85rem' }}><strong>Details:</strong> {errorObj.details}</div>}
                                                        {errorObj.raw_response && (
                                                            <details style={{ marginTop: '0.5rem', fontSize: '0.85rem' }}>
                                                                <summary style={{ cursor: 'pointer' }}>Show raw response</summary>
                                                                <pre style={{ marginTop: '0.5rem', padding: '0.5rem', background: 'var(--bg-input)', borderRadius: '4px', overflow: 'auto', maxHeight: '200px' }}>
                                                                    {errorObj.raw_response}
                                                                </pre>
                                                            </details>
                                                        )}
                                                    </div>
                                                );
                                            } catch {
                                                return error;
                                            }
                                        })()}
                                    </div>
                                )}

                            </div>

                            {entries.length > 0 && (
                                <>
                                    <div className="stats-bar">
                                        <div className="stat-card">
                                            <div className="stat-label">Total</div>
                                            <div className="stat-value">{stats.total}</div>
                                        </div>
                                        <div className="stat-card correct">
                                            <div className="stat-label">Correct</div>
                                            <div className="stat-value">{stats.correct}</div>
                                        </div>
                                        <div className="stat-card incorrect">
                                            <div className="stat-label">Incorrect</div>
                                            <div className="stat-value">{stats.incorrect}</div>
                                        </div>
                                        <div className="stat-card">
                                            <div className="stat-label">Score</div>
                                            <div className="stat-value">{score}%</div>
                                        </div>
                                    </div>

                                    <div className="filter-bar">
                                        <div className="filter-buttons">
                                            <button
                                                className={`filter-btn ${filter === 'all' ? 'active' : ''}`}
                                                onClick={() => setFilter('all')}
                                            >
                                                All ({stats.total})
                                            </button>
                                            <button
                                                className={`filter-btn ${filter === 'correct' ? 'active' : ''}`}
                                                onClick={() => setFilter('correct')}
                                            >
                                                Correct ({stats.correct})
                                            </button>
                                            <button
                                                className={`filter-btn ${filter === 'incorrect' ? 'active' : ''}`}
                                                onClick={() => setFilter('incorrect')}
                                            >
                                                Incorrect ({stats.incorrect})
                                            </button>
                                        </div>
                                        <input
                                            ref={searchRef}
                                            type="text"
                                            placeholder="Search entries..."
                                            value={searchQuery}
                                            onChange={e => setSearchQuery(e.target.value)}
                                            style={{
                                                background: 'var(--bg-input)',
                                                border: '1px solid var(--border)',
                                                borderRadius: '8px',
                                                padding: '0.5rem 0.75rem',
                                                color: 'var(--text-primary)',
                                                fontSize: '0.9rem',
                                                fontFamily: "'Outfit', sans-serif",
                                                width: '200px',
                                            }}
                                        />
                                        <div style={{ position: 'relative' }} ref={exportMenuRef}>
                                            <button
                                                className="secondary"
                                                onClick={() => setShowExportMenu(prev => !prev)}
                                                style={{ whiteSpace: 'nowrap' }}
                                            >
                                                Export
                                            </button>
                                            {showExportMenu && (() => {
                                                const sectionNames = Object.keys(groupedEntries);
                                                const allSelected = sectionNames.length > 0 && sectionNames.every(s => exportSections.has(s));
                                                const getExportEntries = () => {
                                                    return filteredEntries.filter(e => {
                                                        const sec = e.section || 'Uncategorized';
                                                        return exportSections.has(sec);
                                                    });
                                                };
                                                const exportCount = getExportEntries().length;
                                                return (
                                                    <div className="export-popup">
                                                        <div style={{ fontWeight: 600, fontSize: '0.85rem', color: 'var(--text-secondary)', textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: '0.5rem' }}>Sections</div>
                                                        <button
                                                            className="export-popup-toggle"
                                                            onClick={() => {
                                                                if (allSelected) {
                                                                    setExportSections(new Set());
                                                                } else {
                                                                    setExportSections(new Set(sectionNames));
                                                                }
                                                            }}
                                                        >
                                                            {allSelected ? 'Select None' : 'Select All'}
                                                        </button>
                                                        <div className="export-popup-sections">
                                                            {sectionNames.map(sec => (
                                                                <label key={sec} className="export-popup-section-item">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={exportSections.has(sec)}
                                                                        onChange={() => {
                                                                            setExportSections(prev => {
                                                                                const next = new Set(prev);
                                                                                if (next.has(sec)) next.delete(sec);
                                                                                else next.add(sec);
                                                                                return next;
                                                                            });
                                                                        }}
                                                                    />
                                                                    {sec}
                                                                </label>
                                                            ))}
                                                        </div>
                                                        <hr className="export-popup-divider" />
                                                        <div style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', marginBottom: '0.5rem' }}>
                                                            {exportCount} {exportCount === 1 ? 'entry' : 'entries'} selected
                                                        </div>
                                                        <div className="export-popup-actions">
                                                            <button onClick={() => { exportAnki(getExportEntries()); setShowExportMenu(false); }} disabled={exportCount === 0}>
                                                                Export Anki (.apkg)
                                                            </button>
                                                            <button className="secondary" onClick={() => { exportCSV(getExportEntries()); setShowExportMenu(false); }} disabled={exportCount === 0}>
                                                                Export CSV
                                                            </button>
                                                        </div>
                                                    </div>
                                                );
                                            })()}
                                        </div>
                                    </div>

                                    {Object.keys(groupedEntries).map(sectionName => {
                                        const sectionEntries = groupedEntries[sectionName];
                                        const isCollapsed = collapsedSections.has(sectionName);
                                        const sectionStats = sectionEntries.reduce((acc, e) => {
                                            acc.total++;
                                            if (e.result === 'correct') acc.correct++;
                                            if (e.result === 'incorrect') acc.incorrect++;
                                            return acc;
                                        }, { total: 0, correct: 0, incorrect: 0 });

                                        return (
                                            <div key={sectionName} className="section-accordion">
                                                <div
                                                    className={`section-header ${isCollapsed ? 'collapsed' : ''}`}
                                                    onClick={() => toggleSection(sectionName)}
                                                >
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                                                        <span className={`chevron ${isCollapsed ? '' : 'expanded'}`}>▶</span>
                                                        <span className="section-title">{sectionName}</span>
                                                    </div>
                                                    <div className="section-stats">
                                                        <span className="section-stat">Total: {sectionStats.total}</span>
                                                        <span className="section-stat correct">✓ {sectionStats.correct}</span>
                                                        <span className="section-stat incorrect">✗ {sectionStats.incorrect}</span>
                                                    </div>
                                                </div>

                                                {!isCollapsed && (
                                                    <div className="section-content">
                                                        <div className="table-wrapper">
                                                            <table>
                                                                <thead>
                                                                    <tr>
                                                                        <th style={{ width: '60px' }}>#</th>
                                                                        <th style={{ width: '100px' }}>Result</th>
                                                                        <th style={{ width: '30%' }}>Front</th>
                                                                        <th style={{ width: '30%' }}>Back</th>
                                                                        <th style={{ width: '25%' }}>Notes</th>
                                                                        <th style={{ width: '150px' }}>Actions</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {sectionEntries.map(entry => (
                                                                        <tr key={entry.id} className={entry.isNew ? 'new-entry' : ''}>
                                                                            <td className="mono">{entry.number || '—'}</td>
                                                                            <td>
                                                                                <span
                                                                                    className={`result-badge ${entry.result}`}
                                                                                    onClick={() => toggleResult(entry.id)}
                                                                                    title="Click to toggle"
                                                                                >
                                                                                    {entry.result === 'correct' ? '✓ correct' : '✗ incorrect'}
                                                                                </span>
                                                                            </td>
                                                                            <td>
                                                                                <div
                                                                                    className={`cell-content expandable ${expandedCells.has(`${entry.id}-front`) ? 'expanded' : ''
                                                                                        }`}
                                                                                    onClick={(e) => toggleCellExpand(entry.id, 'front', e)}
                                                                                >
                                                                                    {entry.front}
                                                                                </div>
                                                                            </td>
                                                                            <td>
                                                                                <div
                                                                                    className={`cell-content expandable ${expandedCells.has(`${entry.id}-back`) ? 'expanded' : ''
                                                                                        }`}
                                                                                    onClick={(e) => toggleCellExpand(entry.id, 'back', e)}
                                                                                >
                                                                                    {entry.back}
                                                                                </div>
                                                                            </td>
                                                                            <td>
                                                                                <div
                                                                                    className={`cell-content expandable ${expandedCells.has(`${entry.id}-notes`) ? 'expanded' : ''
                                                                                        }`}
                                                                                    onClick={(e) => toggleCellExpand(entry.id, 'notes', e)}
                                                                                    dangerouslySetInnerHTML={{
                                                                                        __html: entry.notes ? formatContent(entry.notes) : '—'
                                                                                    }}
                                                                                />
                                                                            </td>
                                                                            <td>
                                                                                <div style={{ display: 'flex', gap: '0.5rem' }}>
                                                                                    <button
                                                                                        className="edit-btn"
                                                                                        onClick={() => editEntry(entry)}
                                                                                    >
                                                                                        Edit
                                                                                    </button>
                                                                                    <button
                                                                                        className="delete-btn"
                                                                                        onClick={() => deleteEntry(entry.id)}
                                                                                    >
                                                                                        Delete
                                                                                    </button>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                    ))}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                    <div ref={tableEndRef}></div>
                                </>
                            )}

                            {entries.length === 0 && (
                                <div className="empty-state">
                                    <div className="empty-state-icon">📝</div>
                                    {health.status === 'ok' && (
                                        <>
                                            <div className="empty-state-title">Get started in 3 steps</div>
                                            <ol className="getting-started-steps">
                                                <li><span className="step-num">1</span> Enter a section name above (e.g. Upper Limb)</li>
                                                <li><span className="step-num">2</span> Record (<span className="kbd">{'\u2318\u21E7R'}</span>) or paste your transcription</li>
                                                <li><span className="step-num">3</span> Press <span className="kbd">Enter</span> to parse</li>
                                            </ol>
                                            <div className="empty-state-text">
                                                Press <span className="kbd">?</span> to see all keyboard shortcuts
                                            </div>
                                        </>
                                    )}
                                    {health.status === 'downloading' && (
                                        <>
                                            <div className="empty-state-title">Model downloading...</div>
                                            <div className="empty-state-text">
                                                You can start once the download is complete.
                                            </div>
                                        </>
                                    )}
                                    {health.status === 'error' && !showSetup && (
                                        <>
                                            <div className="empty-state-title">Setup needed</div>
                                            <div className="empty-state-text">
                                                Open Settings to configure your parsing backend.
                                            </div>
                                        </>
                                    )}
                                </div>
                            )}

                            {showSetup && (
                                <div className="setup-overlay">
                                    <div className="setup-card">
                                        {setupStep === 'choose' && (
                                            <>
                                                <div className="setup-title">Welcome to Pereste Parse</div>
                                                <div className="setup-subtitle">Choose how you'd like to parse your transcriptions.</div>
                                                <div
                                                    className={`setup-option ${setupBackend === 'cloud' ? 'selected' : ''}`}
                                                    onClick={() => setSetupBackend('cloud')}
                                                >
                                                    <div className="setup-option-title">Cloud (recommended)</div>
                                                    <div className="setup-option-desc">Use Anthropic API. Requires API key, no download needed.</div>
                                                </div>
                                                <div
                                                    className={`setup-option ${setupBackend === 'local' ? 'selected' : ''}`}
                                                    onClick={() => setSetupBackend('local')}
                                                >
                                                    <div className="setup-option-title">Local</div>
                                                    <div className="setup-option-desc">Run models on your Mac. Downloads ~2.5GB model.</div>
                                                </div>
                                                <div className="setup-actions">
                                                    <button onClick={() => setSetupStep('configure')}>Next</button>
                                                </div>
                                            </>
                                        )}

                                        {setupStep === 'configure' && setupBackend === 'cloud' && (
                                            <>
                                                <div className="setup-title">Configure Cloud Backend</div>
                                                <div className="setup-subtitle">Enter your Anthropic API key to get started.</div>
                                                <div className="settings-form">
                                                    <div className="form-group">
                                                        <label>API Key</label>
                                                        <input
                                                            type="password"
                                                            placeholder="sk-ant-..."
                                                            value={setupApiKey}
                                                            onChange={e => setSetupApiKey(e.target.value)}
                                                        />
                                                    </div>
                                                    <div className="form-group">
                                                        <label>Model</label>
                                                        <div className="model-cards">
                                                            <div
                                                                className={`model-card ${setupModel === 'claude-sonnet-4-5-20250929' ? 'selected' : ''}`}
                                                                onClick={() => setSetupModel('claude-sonnet-4-5-20250929')}
                                                            >
                                                                <div className="model-card-name">Claude Sonnet 4.5</div>
                                                                <div className="model-card-desc">Best balance of speed and quality</div>
                                                            </div>
                                                            <div
                                                                className={`model-card ${setupModel === 'claude-haiku-4-5-20251001' ? 'selected' : ''}`}
                                                                onClick={() => setSetupModel('claude-haiku-4-5-20251001')}
                                                            >
                                                                <div className="model-card-name">Claude Haiku 4.5</div>
                                                                <div className="model-card-desc">Fastest and most affordable</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="form-group">
                                                        <button
                                                            className="secondary"
                                                            onClick={setupTestConnection}
                                                            disabled={setupTesting || !setupApiKey}
                                                        >
                                                            {setupTesting ? <><span className="loading"></span> Testing...</> : 'Test Connection'}
                                                        </button>
                                                        {setupTestResult && (
                                                            <div className={`test-result ${setupTestResult.ok ? 'success' : 'failure'}`}>
                                                                {setupTestResult.ok ? '✓' : '✗'} {setupTestResult.message}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="setup-actions" style={{ gap: '0.75rem' }}>
                                                    <button className="secondary" onClick={() => { setSetupStep('choose'); setSetupTestResult(null); }}>Back</button>
                                                    <button onClick={completeSetup} disabled={!setupTestResult?.ok}>Complete Setup</button>
                                                </div>
                                            </>
                                        )}

                                        {setupStep === 'configure' && setupBackend === 'local' && (
                                            <>
                                                <div className="setup-title">Configure Local Backend</div>
                                                <div className="setup-subtitle">Choose a model to download. Larger models are more accurate but need more RAM.</div>
                                                <div className="settings-form">
                                                    <div className="form-group">
                                                        <label>Select Model</label>
                                                        <div className="model-cards">
                                                            {MODEL_PRESETS.map(preset => {
                                                                const status = modelStatuses[preset.id];
                                                                const isDownloading = downloadStatus === 'downloading' && setupSelectedModel?.id === preset.id;
                                                                const isDownloaded = status?.downloaded;

                                                                return (
                                                                    <div
                                                                        key={preset.id}
                                                                        className={`model-card ${setupSelectedModel?.id === preset.id ? 'selected' : ''}`}
                                                                        onClick={() => setSetupSelectedModel(preset)}
                                                                    >
                                                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '0.25rem' }}>
                                                                            <div className="model-card-name">
                                                                                {preset.name} {preset.recommended && '⭐'}
                                                                            </div>
                                                                            {isDownloading && (
                                                                                <span className="loading" style={{ width: '14px', height: '14px', borderWidth: '2px' }}></span>
                                                                            )}
                                                                            {!isDownloading && isDownloaded && (
                                                                                <span style={{ fontSize: '0.85rem', color: 'var(--success)', fontWeight: 600 }}>✓</span>
                                                                            )}
                                                                            {!isDownloading && !isDownloaded && (
                                                                                <span style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>{preset.size}</span>
                                                                            )}
                                                                        </div>
                                                                        <div className="model-card-desc">
                                                                            {preset.description}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                    {!downloadStatus && (
                                                        <button onClick={setupStartDownload}>
                                                            Download {setupSelectedModel?.name || 'Model'} ({setupSelectedModel?.size || ''})
                                                        </button>
                                                    )}
                                                    {downloadStatus === 'downloading' && (
                                                        <div className="download-progress">
                                                            <div className="download-label">
                                                                <span className="loading"></span>
                                                                Downloading model... This may take a few minutes.
                                                            </div>
                                                            <div className="progress-bar-track">
                                                                <div className="progress-bar-fill"></div>
                                                            </div>
                                                        </div>
                                                    )}
                                                    {downloadStatus === 'ready' && (
                                                        <>
                                                            <div className="download-progress complete">
                                                                ✓ Model downloaded successfully!
                                                            </div>
                                                            <button className="secondary" onClick={setupDeleteModel} style={{ fontSize: '0.85rem' }}>Uninstall Model</button>
                                                        </>
                                                    )}
                                                    {downloadStatus === 'error' && (
                                                        <>
                                                            <div className="download-progress error">
                                                                ✗ Download failed. Check your internet connection.
                                                            </div>
                                                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                                                <button onClick={() => { setDownloadStatus(null); }}>Retry Download</button>
                                                                <button className="secondary" onClick={setupDeleteModel} style={{ fontSize: '0.85rem' }}>Uninstall Model</button>
                                                            </div>
                                                        </>
                                                    )}
                                                </div>
                                                <div className="setup-actions" style={{ gap: '0.75rem' }}>
                                                    <button className="secondary" onClick={() => { setSetupStep('choose'); setDownloadStatus(null); }}>Back</button>
                                                    <button onClick={completeSetup} disabled={downloadStatus !== 'ready'}>Complete Setup</button>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                </div>
                            )}

                            {showSettings && settingsForm && (
                                <div className="modal-overlay" onClick={() => setShowSettings(false)}>
                                    <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth: '500px' }}>
                                        <div className="modal-header">
                                            <h2 className="modal-title">Settings</h2>
                                            <button className="modal-close" onClick={() => setShowSettings(false)}>×</button>
                                        </div>
                                        <div className="modal-body">
                                            <div className="settings-form">
                                                <div className="form-group">
                                                    <label>Parsing Backend</label>
                                                    <div className="backend-toggle">
                                                        <button
                                                            className={settingsForm.parsing_backend === 'local' ? 'active' : 'secondary'}
                                                            onClick={() => setSettingsForm(prev => ({ ...prev, parsing_backend: 'local' }))}
                                                        >
                                                            Local
                                                        </button>
                                                        <button
                                                            className={settingsForm.parsing_backend === 'cloud' ? 'active' : 'secondary'}
                                                            onClick={() => setSettingsForm(prev => ({ ...prev, parsing_backend: 'cloud' }))}
                                                        >
                                                            Cloud
                                                        </button>
                                                    </div>
                                                </div>

                                                <div className="form-group">
                                                    <label>Default Result</label>
                                                    <div className="backend-toggle">
                                                        <button
                                                            className={settingsForm.default_result === 'incorrect' ? 'active' : 'secondary'}
                                                            onClick={() => setSettingsForm(prev => ({ ...prev, default_result: 'incorrect' }))}
                                                            style={{ background: settingsForm.default_result === 'incorrect' ? 'var(--error)' : undefined }}
                                                        >
                                                            Incorrect
                                                        </button>
                                                        <button
                                                            className={settingsForm.default_result === 'correct' ? 'active' : 'secondary'}
                                                            onClick={() => setSettingsForm(prev => ({ ...prev, default_result: 'correct' }))}
                                                            style={{ background: settingsForm.default_result === 'correct' ? 'var(--success)' : undefined }}
                                                        >
                                                            Correct
                                                        </button>
                                                    </div>
                                                </div>

                                                <div className="form-group">
                                                    <label>Debug Mode</label>
                                                    <div className="backend-toggle">
                                                        <button
                                                            className={!settingsForm.debug_mode ? 'active' : 'secondary'}
                                                            onClick={() => setSettingsForm(prev => ({ ...prev, debug_mode: false }))}
                                                        >
                                                            Off
                                                        </button>
                                                        <button
                                                            className={settingsForm.debug_mode ? 'active' : 'secondary'}
                                                            onClick={() => setSettingsForm(prev => ({ ...prev, debug_mode: true }))}
                                                        >
                                                            On
                                                        </button>
                                                    </div>
                                                </div>

                                                {settingsForm.parsing_backend === 'cloud' && (
                                                    <>
                                                        <div className="form-group">
                                                            <label>API Key {settings?.api_key ? `(current: ${settings.api_key})` : ''}</label>
                                                            <input
                                                                type="password"
                                                                placeholder="sk-ant-..."
                                                                value={settingsForm.api_key}
                                                                onChange={e => setSettingsForm(prev => ({ ...prev, api_key: e.target.value }))}
                                                            />
                                                        </div>
                                                        <div className="form-group">
                                                            <label>Model</label>
                                                            <div className="model-cards">
                                                                <div
                                                                    className={`model-card ${settingsForm.cloud_model === 'claude-sonnet-4-5-20250929' ? 'selected' : ''}`}
                                                                    onClick={() => setSettingsForm(prev => ({ ...prev, cloud_model: 'claude-sonnet-4-5-20250929' }))}
                                                                >
                                                                    <div className="model-card-name">Claude Sonnet 4.5</div>
                                                                    <div className="model-card-desc">Best balance of speed and quality</div>
                                                                </div>
                                                                <div
                                                                    className={`model-card ${settingsForm.cloud_model === 'claude-haiku-4-5-20251001' ? 'selected' : ''}`}
                                                                    onClick={() => setSettingsForm(prev => ({ ...prev, cloud_model: 'claude-haiku-4-5-20251001' }))}
                                                                >
                                                                    <div className="model-card-name">Claude Haiku 4.5</div>
                                                                    <div className="model-card-desc">Fastest and most affordable</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="form-group">
                                                            <button
                                                                className="secondary"
                                                                onClick={testConnection}
                                                                disabled={testingConnection}
                                                            >
                                                                {testingConnection ? <><span className="loading"></span> Testing...</> : 'Test Connection'}
                                                            </button>
                                                            {testResult && (
                                                                <div className={`test-result ${testResult.ok ? 'success' : 'failure'}`}>
                                                                    {testResult.ok ? '✓' : '✗'} {testResult.message}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </>
                                                )}

                                                {settingsForm.parsing_backend === 'local' ? (
                                                    <>
                                                        <div style={{ borderTop: '1px solid var(--border)', paddingTop: '1rem', marginTop: '0.5rem' }}>
                                                            <label style={{ fontSize: '0.95rem', fontWeight: 600, color: 'var(--text-primary)' }}>Local Model Settings</label>
                                                        </div>
                                                        {renderLocalModelFields()}
                                                    </>
                                                ) : (
                                                    <div>
                                                        <div
                                                            style={{ cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '0.5rem', color: 'var(--text-secondary)', fontSize: '0.9rem', borderTop: '1px solid var(--border)', paddingTop: '1rem', marginTop: '0.5rem' }}
                                                            onClick={() => setShowAdvanced(prev => !prev)}
                                                        >
                                                            <span style={{ transition: 'transform 0.2s', transform: showAdvanced ? 'rotate(90deg)' : 'rotate(0deg)', fontSize: '0.8rem' }}>&#9654;</span>
                                                            Advanced (Local Model)
                                                        </div>
                                                        {showAdvanced && (
                                                            <div style={{ marginTop: '1rem', display: 'flex', flexDirection: 'column', gap: '1.25rem' }}>
                                                                {renderLocalModelFields()}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}

                                                <div style={{ borderTop: '1px solid var(--border)', paddingTop: '1rem', marginTop: '0.5rem' }}>
                                                    <label style={{ fontSize: '0.95rem', fontWeight: 600, color: 'var(--text-primary)', marginBottom: '0.5rem', display: 'block' }}>Data</label>
                                                    <input
                                                        type="file"
                                                        accept=".csv"
                                                        style={{ display: 'none' }}
                                                        id="csv-import-input-settings"
                                                        onChange={async (e) => {
                                                            const file = e.target.files[0];
                                                            if (!file) return;

                                                            try {
                                                                const formData = new FormData();
                                                                formData.append('file', file);

                                                                const res = await fetch('/api/import-csv', {
                                                                    method: 'POST',
                                                                    body: formData
                                                                });

                                                                const data = await res.json();
                                                                if (res.ok && data.success) {
                                                                    if (confirm(`Import ${data.count} entries? This will add to your existing data.`)) {
                                                                        // Ensure imported entries have unique IDs
                                                                        const newEntries = data.entries.map(e => ({
                                                                            ...e,
                                                                            id: Date.now() + Math.random() // simple unique ID
                                                                        }));
                                                                        setEntries(prev => [...prev, ...newEntries]);
                                                                        showToast(`Imported ${data.count} entries`);
                                                                        setShowSettings(false);
                                                                    }
                                                                } else {
                                                                    alert('Import failed: ' + (data.error || 'Unknown error'));
                                                                }
                                                            } catch (err) {
                                                                alert('Import failed: ' + err.message);
                                                            }
                                                            e.target.value = '';
                                                        }}
                                                    />
                                                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                                                        <button
                                                            className="secondary"
                                                            style={{ fontSize: '0.85rem', padding: '0.5rem 1rem' }}
                                                            onClick={() => document.getElementById('csv-import-input-settings').click()}
                                                        >
                                                            Import CSV Backup
                                                        </button>
                                                        <button
                                                            className="danger"
                                                            style={{ fontSize: '0.85rem', padding: '0.5rem 1rem' }}
                                                            onClick={() => {
                                                                clearAll();
                                                                setShowSettings(false);
                                                            }}
                                                        >
                                                            Clear All Entries
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="modal-actions">
                                            <button className="secondary" onClick={() => setShowSettings(false)}>Cancel</button>
                                            <button onClick={saveSettings}>Save</button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {editingEntry && (
                                <div className="modal-overlay" onClick={() => setEditingEntry(null)}>
                                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                                        <div className="modal-header">
                                            <h2 className="modal-title">Edit Entry</h2>
                                            <button className="modal-close" onClick={() => setEditingEntry(null)}>×</button>
                                        </div>

                                        <div className="modal-body">
                                            <div className="anki-card" onClick={flipCard}>
                                                {showingFront ? (
                                                    <>
                                                        <div className="anki-card-label">Front</div>
                                                        <div className="anki-card-content formatted-content" dangerouslySetInnerHTML={{ __html: formatContent(editingEntry.front) }} />
                                                        <div className="anki-card-hint">Click to flip</div>
                                                    </>
                                                ) : (
                                                    <>
                                                        <div className="anki-card-label">Back</div>
                                                        <div className="anki-card-content formatted-content" dangerouslySetInnerHTML={{ __html: formatContent(editingEntry.back) }} />
                                                        <div className="anki-card-hint">Click to flip</div>
                                                    </>
                                                )}
                                            </div>

                                            <div className="edit-form">
                                                <div className="form-group">
                                                    <label>Result</label>
                                                    <div className="result-toggle">
                                                        <button
                                                            className={editingEntry.result === 'correct' ? 'active' : 'secondary'}
                                                            onClick={() => updateEditingEntry('result', 'correct')}
                                                        >
                                                            ✓ Correct
                                                        </button>
                                                        <button
                                                            className={editingEntry.result === 'incorrect' ? 'active' : 'secondary'}
                                                            onClick={() => updateEditingEntry('result', 'incorrect')}
                                                        >
                                                            ✗ Incorrect
                                                        </button>
                                                    </div>
                                                </div>

                                                <div className="form-group">
                                                    <label>Question Number</label>
                                                    <input
                                                        type="number"
                                                        value={editingEntry.number || ''}
                                                        onChange={e => updateEditingEntry('number', e.target.value ? parseInt(e.target.value) : null)}
                                                    />
                                                </div>

                                                <div className="form-group">
                                                    <label>Section</label>
                                                    <input
                                                        type="text"
                                                        list="sections-datalist-modal"
                                                        placeholder="e.g. Thorax, Upper Limb, Head and Neck"
                                                        value={editingEntry.section || ''}
                                                        onChange={e => updateEditingEntry('section', e.target.value)}
                                                    />
                                                    <datalist id="sections-datalist-modal">
                                                        {uniqueSections.map(sec => (
                                                            <option key={sec} value={sec} />
                                                        ))}
                                                    </datalist>
                                                </div>

                                                <div className="form-group">
                                                    <label>Front (Question)</label>
                                                    <textarea
                                                        value={editingEntry.front || ''}
                                                        onChange={e => updateEditingEntry('front', e.target.value)}
                                                    />
                                                </div>

                                                <div className="form-group">
                                                    <label>Back (Answer)</label>
                                                    <textarea
                                                        value={editingEntry.back || ''}
                                                        onChange={e => updateEditingEntry('back', e.target.value)}
                                                    />
                                                </div>

                                                <div className="form-group">
                                                    <label>Tags (comma-separated)</label>
                                                    <input
                                                        type="text"
                                                        value={Array.isArray(editingEntry.tags) ? editingEntry.tags.join(', ') : ''}
                                                        onChange={e => updateEditingEntry('tags', e.target.value.split(',').map(t => t.trim().replace(/\s+/g, '_')).filter(Boolean))}
                                                    />
                                                </div>

                                                <div className="form-group">
                                                    <label>Notes</label>
                                                    <textarea
                                                        value={editingEntry.notes || ''}
                                                        onChange={e => updateEditingEntry('notes', e.target.value)}
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        <div className="modal-actions">
                                            <button className="secondary" onClick={() => setEditingEntry(null)}>Cancel</button>
                                            <button onClick={saveEdit}>Save Changes</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {showDebug && settings?.debug_mode && (
                        <div style={{
                            width: '400px',
                            minWidth: '400px',
                            borderLeft: '1px solid var(--border)',
                            background: 'var(--bg-card)',
                            display: 'flex',
                            flexDirection: 'column',
                            overflow: 'hidden',
                        }}>
                            <div style={{
                                padding: '1rem',
                                borderBottom: '1px solid var(--border)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                            }}>
                                <strong style={{ fontSize: '0.9rem' }}>Debug Log</strong>
                                <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                                    <span style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>{debugLog.length} entries</span>
                                    {debugLog.length > 0 && (
                                        <button className="secondary" onClick={() => setDebugLog([])} style={{ fontSize: '0.75rem', padding: '0.2rem 0.5rem' }}>Clear</button>
                                    )}
                                    <button className="secondary" onClick={() => setShowDebug(false)} style={{ fontSize: '0.75rem', padding: '0.2rem 0.5rem' }}>×</button>
                                </div>
                            </div>
                            <div style={{ flex: 1, overflow: 'auto', fontFamily: "'JetBrains Mono', monospace", fontSize: '0.78rem' }}>
                                {debugLog.length === 0 && (
                                    <div style={{ padding: '2rem 1rem', textAlign: 'center', color: 'var(--text-secondary)' }}>
                                        Parse a question to see debug output here.
                                    </div>
                                )}
                                {[...debugLog].reverse().map((log, i) => (
                                    <div key={i} style={{ padding: '0.75rem 1rem', borderBottom: '1px solid var(--border)' }}>
                                        <div style={{ color: 'var(--text-secondary)', marginBottom: '0.5rem', fontSize: '0.72rem' }}>
                                            {log.timestamp} &middot; {log.backend} &middot; {log.model}{log.attempt ? ` &middot; attempt ${log.attempt}` : ''}
                                        </div>
                                        <div style={{ marginBottom: '0.25rem', color: 'var(--accent)', fontWeight: 600 }}>INPUT</div>
                                        <pre style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-word', margin: '0 0 0.75rem 0', color: 'var(--text-primary)', lineHeight: 1.4 }}>{log.input}</pre>
                                        <div style={{ marginBottom: '0.25rem', color: 'var(--success)', fontWeight: 600 }}>RAW OUTPUT</div>
                                        <pre style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-word', margin: 0, color: 'var(--text-primary)', lineHeight: 1.4 }}>{log.raw_output}</pre>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {showShortcuts && (
                        <div className="modal-overlay" onClick={() => setShowShortcuts(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth: '440px' }}>
                                <div className="modal-header">
                                    <h2 className="modal-title">Keyboard Shortcuts</h2>
                                    <button className="modal-close" onClick={() => setShowShortcuts(false)}>×</button>
                                </div>
                                <div className="modal-body" style={{ padding: '0.5rem 0' }}>
                                    <table className="shortcuts-table">
                                        <tbody>
                                            {SHORTCUTS.map((s, i) => (
                                                <tr key={i}>
                                                    <td><span className="kbd">{s.keys}</span></td>
                                                    <td>{s.desc}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}

                    {toast && <div className="toast">{toast}</div>}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));

        // Register service worker for PWA support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>
</body>

</html>